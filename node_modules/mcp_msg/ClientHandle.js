var CronJob = require("cron").CronJob;
var async = require('async');
var moment = require("moment");
var dc = require('mcp_db').dc;
var prop = require('mcp_config').prop;
var esut = require("easy_util");
var log = esut.log;
var digestUtil = esut.digestUtil;
var termSer = require("mcp_service").termSer;

var cons = require('mcp_constants');
var termStatus = cons.termStatus;
var msgStatus = cons.msgStatus;
var msgType = cons.msgType;

var termHandle = require("./ClientTermHandle.js");

var ClientHandle = function(){};

/**
 * 从池中获取需要处理的消息
 * @param cb
 */
ClientHandle.prototype.getFromPool = function(cb)
{
    var msg = dc.mg_msg.getConn().collection("msg");
    msg.findAndModify({status:msgStatus.INIT}, {},
    {$set:{status:msgStatus.HANDLING}}, [], function(err, data){
        cb(err, data);
    });
}

/**
 * 处理消息
 * @param msg
 * @param cb
 */
ClientHandle.prototype.handle = function(msg, cb)
{
    var self = this;
    if(msg.type == msgType.TERM)
    {
        var table = dc.mg_msg.get("detail_term");
        table.findOne({msgId:msg._id}, {}, [], function(err, dTerm){
            termHandle.handle(msg, dTerm, cb);
        });
    }
    else
    {
        cb(null);
    }
}

module.exports = new ClientHandle();


