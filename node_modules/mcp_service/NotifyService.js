var async = require('async');
var dc = require('mcp_db').dc;

var cons = require("mcp_constants");
var userType = cons.userType;
var notifyType = cons.notifyType;
var notifyStatus = cons.notifyStatus;

var config = require("mcp_config");
var ec = config.ec;

var kvSer = require("./KvService.js");


var NotifyService = function(){};


NotifyService.prototype.saveOrder = function(order, cb)
{

};

/**
 * 生成期次通知
 * @param term
 * @param cb
 */
NotifyService.prototype.saveTerm = function(term, cb)
{
    var self = this;
    async.waterfall([
        //查找所有的渠道
        function(cb)
        {
            var table = dc.main.get("customer");
            var cond = {type:userType.CHANNEL};
            table.find(cond, {}).toArray(function(err, data){
                if(err)
                {
                    cb(ec.E0999);
                    return;
                }
                cb(null, data);
            });
        },
        //保存期次信息到队列
        function(customers, cb)
        {
            var table = dc.mg.get("notifyqueen");
            var now = new Date().getTime();
            async.each(customers, function(customer, callback) {
                //获得id序号
                kvSer.getNotifyQueenId(function(err, data){
                    if(err)
                    {
                        callback(ec.E0999);
                        return;
                    }
                    table.save({_id:data.value, content:term,
                    createTime:now, version:0, customerId:customer.id,
                    type:notifyType.TERM, status:notifyStatus.WAIT_TAKE},
                        [], function(err, data){
                        callback(err);
                    });
                });
            }, function(err){
                cb(err);
            });
        }
    ], function (err, rst) {
        cb(err, rst);
    });
};

module.exports = new NotifyService();