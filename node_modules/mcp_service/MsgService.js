var async = require('async');
var dc = require('mcp_db').dc;
var esut = require("easy_util");

var cons = require('mcp_constants');
var msgType = cons.msgType;
var msgStatus = cons.msgStatus;
var termStatus = cons.termStatus;

var log = esut.log;
var digestUtil = esut.digestUtil;

var config = require("mcp_config");
var prop = config.prop;

var MsgService = function(){};

MsgService.prototype.saveTerm = function(term, cb)
{
    var self = this;
    log.info(term);
    if(term.status = termStatus.IN_CALCULATE)
    {
        self.saveCheckTerm(term, cb);
        return;
    }
    async.waterfall([
        function(cb)
        {
            var msgId = digestUtil.createUUID();
            var detail_term = {gameCode:term.gameCode, code:term.code,
                nextCode:term.nextCode, status:term.status,
                msgId:msgId, termId:term.id};
            detail_term._id = detail_term.gameCode + "_" + detail_term.code +
                "_" + detail_term.status;
            var detail_term_table = dc.mg_msg.get("detail_term");
            detail_term_table.save(detail_term, [], function(err, data){
                cb(err, msgId);
            });
        },
        //保存消息
        function(msgId, cb)
        {
            var msg = {_id:msgId,
                parentId:'', type:msgType.TERM, subCount:0, finishCount:0,
                status:msgStatus.INIT, version:0, createTime:new Date().getTime()};
            var table = dc.mg_msg.get("msg");
            table.save(msg, [], function(err, data){
                cb(err, msg);
            });
        }
    ], function (err, result) {
        cb(err, result);
    });
}

MsgService.prototype.saveCheckTerm = function(term, cb)
{
    async.waterfall([
        function(cb)
        {
            var msgId = digestUtil.createUUID();
            var detail_term = {gameCode:term.gameCode, code:term.code,
                nextCode:term.nextCode, status:term.status,
                msgId:msgId, termId:term.id};
            detail_term._id = detail_term.gameCode + "_" + detail_term.code +
                "_" + detail_term.status;
            var detail_term_table = dc.mg_msg.get("detail_term");
            detail_term_table.save(detail_term, [], function(err, data){
                cb(err, msgId);
            });
        },
        //保存消息
        function(msgId, cb)
        {
            var msg = {_id:msgId,
                parentId:'', type:msgType.TERM, subCount:0, finishCount:0,
                status:msgStatus.WAIT_CHILD, version:0, createTime:new Date().getTime(),
                };
            var table = dc.mg_msg.get("msg");
            table.save(msg, [], function(err, data){
                cb(err, msg);
            });
        }
    ], function (err, result) {
        cb(err, result);
    });
}

MsgService.prototype.updateStatus = function(id, status, cb)
{
    var self = this;
    var table = dc.mg_msg.get("msg");
    var cond = {_id:id};
    var data = {status:status};
    if(status == msgStatus.FINISHED)
    {
        data.finishTime = new Date().getTime();
    }
    table.update(cond, {$set:data}, [], function(err, data){
        if(err)
        {
            log.info(err);
        }
        else
        {
            if(cb)
            {
                cb(err, data);
            }
        }
    });
}

module.exports = new MsgService();
