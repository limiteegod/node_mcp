var async = require('async');
var dc = require('mcp_db').dc;
var esut = require("easy_util");
var cons = require('mcp_constants');
var msgType = cons.msgType;
var msgStatus = cons.msgStatus;
var log = esut.log;
var digestUtil = esut.digestUtil;

var MsgService = function(){};

MsgService.prototype.saveTerm = function(term, cb)
{
    var self = this;
    async.waterfall([
        //保存消息内容
        function(cb)
        {
            var detail_term = {gameCode:term.gameCode, code:term.code,
                nextCode:term.nextCode, status:term.status};
            detail_term._id = detail_term.gameCode + "_" + detail_term.code +
                "_" + detail_term.status;
            var detail_term_table = dc.mg_msg.get("detail_term");
            detail_term_table.save(detail_term, [], function(err, data){
                cb(err, detail_term);
            });
        },
        //保存消息
        function(detail_term, cb)
        {
            var msg = {_id:digestUtil.createUUID(), detailId:detail_term._id,
            parentId:'', type:msgType.TERM, subCount:0, finishCount:0,
            status:msgStatus.INIT, version:0};
            var table = dc.mg_msg.get("msg");
            table.save(msg, [], function(err, data){
                cb(err);
            });
        }
    ], function (err, result) {
        cb(err, result);
    });
}

module.exports = new MsgService();
