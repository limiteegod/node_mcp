var async = require('async');

var esut = require('easy_util');
var log = esut.log;

var cons = require('mcp_constants');
var termStatus = cons.termStatus;
var ticketStatus = cons.ticketStatus;
var ticketPrintStatus = cons.ticketPrintStatus;


var config = require('mcp_config');
var ec = config.ec;

var dc = require("mcp_db").dc;

var feoValidate = require("mcp_feo").validate;

var ValidateFactory = function(){};

ValidateFactory.prototype.validate = function(order, cb)
{
    var self = this;
    var terms = {};
    var tickets = order.tickets;
    var totalTicketAmount = 0;
    if(!order.outerId)
    {
        cb(ec.E2064, null);
        return;
    }
    async.eachSeries(tickets, function(ticket, callback) {
        var name = "validate" + ticket.gameCode;
        totalTicketAmount += ticket.amount;
        if (!ticket.outerId)
        {
            ticket.ec = ec.E2064;
            callback();
            return;
        }
        self.checkTerm(terms, ticket, function(err, term){
            if(err)
            {
                ticket.ec = ec.E0999;
                callback();
            }
            else
            {
                //期次必须在销售状态
                if(term.status != termStatus.ON_SALE)
                {
                    ticket.ec = ec.E2008;
                    callback();
                    return;
                }
                ticket.status = ticketStatus.UN_OPEN;
                ticket.printStatus = ticketPrintStatus.WAITING_PRINT;
                if(self[name])
                {
                    self.checkGame(order, ticket, function(err, data) {
                        if (err) {
                            ticket.ec = ec.E0999;
                            callback();
                        }
                        else
                        {
                            self[name](order, ticket, function(err, data){
                                if(err)
                                {
                                    ticket.ec = err;
                                }
                                else
                                {
                                    ticket.ec = ec.E0000;
                                }
                                callback();
                            });
                        }
                    });
                }
                else
                {
                    ticket.ec = ec.E2063;
                    callback();
                }
            }
        });
    }, function(err){
        if(err)
        {
            cb(err);
        }
        else
        {
            if(totalTicketAmount != order.amount)
            {
                cb(ec.E2061);
            }
            else
            {
                cb(null);
            }
        }
    });
};

/**
 * 校验游戏是否可用
 * @param order
 * @param ticket
 * @param cb
 */
ValidateFactory.prototype.checkGame = function(order, ticket, cb)
{
    var table = dc.mg.get("relation");
    var cond = {_id:order.customerId + "_" + ticket.gameCode};
    table.findOne(cond, {}, [], function(err, data){
        if(err)
        {
            cb(ec.E0999);
        }
        else
        {
            if(!data)
            {
                cb(ec.E2068);
            }
            else
            {
                ticket.printId = data.relayTo;
                cb(null);
            }
        }
    });
}

/**
 * 获取期次状态
 * @param gameCode
 * @param termCode
 */
ValidateFactory.prototype.checkTerm = function(terms, ticket, cb)
{
    var key = ticket.gameCode + "_" + ticket.termCode;
    var term = terms[key];
    if(!term)
    {
        var table = dc.main.get("term");
        table.findOne({id:key}, {}, [], function(err, data){
            if(err)
            {
                cb(ec.E0999);
            }
            else
            {
                if(data)
                {
                    terms[data.id] = data;
                    cb(null, data);
                }
                else
                {
                    cb(ec.E2065);
                }
            }
        });
    }
    else
    {
        cb(null, term);
    }
};

ValidateFactory.prototype.validateT06 = function(order, ticket, cb)
{
    var self = this;
    feoValidate.validate(order, ticket, cb);
};

module.exports = new ValidateFactory();