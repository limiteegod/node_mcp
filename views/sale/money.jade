doctype html
html(lang="en")
    head
        include ../includes/script.jade
        script(type='text/javascript').
            KISSY.use("io,node,json,vs-grid-table,vs-pagebar,vs-round-input,vs-window",
                function(S, Io, Node, Json, VsGridTable, VsPagebar, VsRoundInput, VsWindow){
                DOM = S.DOM;
                var count = parseInt(Node.one('#count').val());
                var skip = parseInt(Node.one('#skip').val());
                var limit = parseInt(Node.one('#limit').val());
                var cur = parseInt(skip/limit) + 1;
                var table = new VsGridTable('#moneylogs', {});
                var pageBar = new VsPagebar('#bar', {count:count, limit:limit, cur:cur, toPage:function(index){
                    toPage(index);
                }});
                var getCondition = function()
                {
                    var cond = {};
                    var accountId = Node.one('#accountId').val();
                    if(accountId && accountId.length > 0){
                        cond.accountId = accountId;
                    }

                    var expenseDisplay = DOM.css(Node.one("#expense"),'display');

                    var subjectId="";
                    if(expenseDisplay=="none"){
                      subjectId = Node.one('#incomeId').val();
                    }else{
                      subjectId = Node.one('#expenseId').val();
                    }
                    if(subjectId && subjectId.length > 0){
                        cond.subjectId = subjectId;
                    }
                   return cond;
                };
                var toPage = function(index){
                    var limit = parseInt(Node.one('#limit').val());
                    var skip = (index - 1)*limit;
                    var cond = encodeURIComponent(Json.stringify(getCondition()));
                    CurSite.redirectTo(null, "sale_money.html?" + 'skip=' + skip + "&limit=" + limit + "&cond=" + cond);
                };
                                                  //绑定事件
                Node.one("#search").on("click", function(){
                    toPage(cur);
                });

                Node.one("#accountId").on("change", function(){
                    var accountId = parseInt(Node.one('#accountId').val());
                    if(accountId==0){
                      Node.one("#expense").hide();
                      Node.one("#income").show();
                      return;
                    }else if(accountId==1){
                      Node.one("#income").hide();
                      Node.one("#expense").show();
                      return;
                    }
                    Node.one("#income").hide();
                    Node.one("#expense").hide();
                });

                var accountId = parseInt(Node.one('#accountId').val());
                if(accountId==0){
                     Node.one("#expense").hide();
                     Node.one("#income").show();
                }else if(accountId==1){
                     Node.one("#income").hide();
                     Node.one("#expense").show();
                }
            });
    body
        .bodyAdminDiv
            input(type='hidden', id="count", value=count)
            input(type='hidden', id="skip", value=skip)
            input(type='hidden', id="limit", value=limit)
            #tWin.container
            .clearfix(style="margin-top:8px;")
                .vs_grid_plain(style="padding-top:6px;margin-left:12px;") 资金走向:
                .vs_grid_plain(style="padding-top:4px;")
                    select(id="accountId")
                        option(value="") 所有
                        -  each val in accountType
                            if(val.id == cond.accountId)
                                option(value=val.id, selected="true")=val.name
                            else
                                option(value=val.id)=val.name
                .vs_grid_plain(style="padding-top:6px;margin-left:12px;") 科目:
                .vs_grid_plain(style="padding-top:4px;display:none" id="income")
                    select(id="incomeId")
                        option(value="") 所有
                        -  each val in accountIncome
                            if(val.id == cond.subjectId)
                                option(value=val.id, selected="true")=val.name
                            else
                                option(value=val.id)=val.name
                .vs_grid_plain(style="padding-top:4px;display:none" id="expense")
                    select(id="expenseId")
                        option(value="") 所有
                        -  each _val0 in accountExpense
                            if(_val0.id == cond.subjectId)
                                option(value=_val0.id, selected="true")=_val0.name
                            else
                                option(value=_val0.id)=_val0.name
            .clearfix(style="margin-top:8px")
                .vs_grid_plain(style="width:423px;")
                    input(type="button", id="search", value="查询")
            .clearfix(style="margin-top:8px")
                #moneylogs.container(style="width:423px;")
                    table
                        thead
                            tr
                                td(w="80") 用户
                                td(w="80") 科目
                                td(w="120") 操作前
                                td(w="120") 操作后
                                td(w="100") 金额
                                td(w="240") 订单号
                                td(w="160") 创建时间
                        tbody
                            - each val in rst
                                tr
                                    td=val.customerId
                                    td=val.subject.name
                                    td=val.stateBefore/100
                                    td=val.stateAfter/100
                                    td=val.amount/100
                                    td=val.orderId
                                    td=val.createTime
            .clearfix(style="margin-top:8px")
                #bar.vs_grid_plain(style="width:600px;")
                                  